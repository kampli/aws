AWSTemplateFormatVersion: "2010-09-09"
Description: LAMP Stack on Amazon Linux 2023 (EC2 + Apache + PHP + MariaDB)

Parameters:
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: Name of an existing EC2 KeyPair for SSH access

  InstanceType:
    Type: String
    Default: t2.micro
    AllowedValues:
      - t2.micro
      - t3.micro
    Description: EC2 instance type

  DBRootPassword:
    Type: String
    NoEcho: true
    MinLength: 8
    Default: rootkampli00
    Description: mysql DB root password
  
  WordPressDBName:
    Type: String
    Default: wordpressdb

  WordPressDBUser:
    Type: String
    Default: wpuser

  WordPressDBPassword:
    Type: String
    NoEcho: true
    MinLength: 8
    Default: wpkampli00

  VpcCIDR:
    Type: String
    Default: 10.0.0.0/16
    
  DBVPCCIDR:
    Type: String
    Default: 10.1.0.0/16


  PublicSubnetCIDRs:
    Type: CommaDelimitedList
    Default: 10.0.1.0/24,10.0.2.0/24,10.0.3.0/24

  PrivateSubnetCIDRs:
    Type: CommaDelimitedList
    Default: 10.0.101.0/24,10.0.102.0/24,10.0.103.0/24

  DomainName:
    Type: String
    Default: kampli.co.uk

  HostedZoneId:
    Type: String
    Description: Route53 Hosted Zone ID for kampli.co.uk (e.g. Z123ABCXYZ)

  LambdaArtifactsS3BucketName:
    Type: String
    Default: lamp-lambda-artifacts-725673811658-eu-west-2
    Description: "Existing bucket name or new bucket name"

Resources:

  VPC:
    Type: "AWS::EC2::VPC"
    Properties:
      CidrBlock: !Ref VpcCIDR
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: "Name"
          Value: "LAMP Stack - VPC"

  PublicSubnet1:
    Type: "AWS::EC2::Subnet"
    Properties:
      CidrBlock: !Select [0, !Ref PublicSubnetCIDRs]
      MapPublicIpOnLaunch: true
      VpcId:
        Ref: "VPC"
      Tags:
        - Key: "Name"
          Value: "Public Subnet AZ A"
      AvailabilityZone:
        Fn::Select:
          - "0"
          - Fn::GetAZs:
              Ref: "AWS::Region"

  PublicSubnet2:
    Type: "AWS::EC2::Subnet"
    Properties:
      CidrBlock: !Select [1, !Ref PublicSubnetCIDRs]
      MapPublicIpOnLaunch: true
      VpcId:
        Ref: "VPC"
      Tags:
        - Key: "Name"
          Value: "Public Subnet AZ B"
      AvailabilityZone:
        Fn::Select:
          - "1"
          - Fn::GetAZs:
              Ref: "AWS::Region"

  PublicSubnet3:
    Type: "AWS::EC2::Subnet"
    Properties:
      CidrBlock: !Select [2, !Ref PublicSubnetCIDRs]
      MapPublicIpOnLaunch: true
      VpcId:
        Ref: "VPC"
      Tags:
        - Key: "Name"
          Value: "Public Subnet AZ C"
      AvailabilityZone:
        Fn::Select:
          - "2"
          - Fn::GetAZs:
              Ref: "AWS::Region"

  PrivateSubnet1:
    Type: "AWS::EC2::Subnet"
    Properties:
      CidrBlock: !Select [0, !Ref PrivateSubnetCIDRs]
      MapPublicIpOnLaunch: false
      VpcId:
        Ref: "VPC"
      Tags:
        - Key: "Name"
          Value: "Private Subnet AZ A"
      AvailabilityZone:
        Fn::Select:
          - "0"
          - Fn::GetAZs:
              Ref: "AWS::Region"

  PrivateSubnet2:
    Type: "AWS::EC2::Subnet"
    Properties:
      CidrBlock: !Select [1, !Ref PrivateSubnetCIDRs]
      MapPublicIpOnLaunch: false
      VpcId:
        Ref: "VPC"
      Tags:
        - Key: "Name"
          Value: "Private Subnet AZ B"
      AvailabilityZone:
        Fn::Select:
          - "1"
          - Fn::GetAZs:
              Ref: "AWS::Region"

  PrivateSubnet3:
    Type: "AWS::EC2::Subnet"
    Properties:
      CidrBlock: !Select [2, !Ref PrivateSubnetCIDRs]
      MapPublicIpOnLaunch: false
      VpcId:
        Ref: "VPC"
      Tags:
        - Key: "Name"
          Value: "Private Subnet AZ C"
      AvailabilityZone:
        Fn::Select:
          - "2"
          - Fn::GetAZs:
              Ref: "AWS::Region"

  RouteTablePublic:
    Type: "AWS::EC2::RouteTable"
    Properties:
      VpcId:
        Ref: "VPC"
      Tags:
        - Key: "Name"
          Value: "Public Route Table"

  RouteTablePublicAssociation1:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Properties:
      RouteTableId:
        Ref: "RouteTablePublic"
      SubnetId:
        Ref: "PublicSubnet1"

  RouteTablePublicAssociation2:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Properties:
      RouteTableId:
        Ref: "RouteTablePublic"
      SubnetId:
        Ref: "PublicSubnet2"

  RouteTablePublicAssociation3:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Properties:
      RouteTableId:
        Ref: "RouteTablePublic"
      SubnetId:
        Ref: "PublicSubnet3"

  RouteTablePublicRoute0:
    Type: "AWS::EC2::Route"
    Properties:
      DestinationCidrBlock: "0.0.0.0/0"
      RouteTableId:
        Ref: "RouteTablePublic"
      GatewayId:
        Ref: "Igw"

  RouteTablePrivate1:
    Type: "AWS::EC2::RouteTable"
    Properties:
      VpcId:
        Ref: "VPC"
      Tags:
        - Key: "Name"
          Value: "Private Route Table A"

  RouteTablePrivate1Association1:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Properties:
      RouteTableId:
        Ref: "RouteTablePrivate1"
      SubnetId:
        Ref: "PrivateSubnet1"

  RouteTablePrivate1Route0:
    Type: "AWS::EC2::Route"
    Properties:
      DestinationCidrBlock: "0.0.0.0/0"
      RouteTableId:
        Ref: "RouteTablePrivate1"
      NatGatewayId:
        Ref: "NatGw1"

  RouteTablePrivate2:
    Type: "AWS::EC2::RouteTable"
    Properties:
      VpcId:
        Ref: "VPC"
      Tags:
        - Key: "Name"
          Value: "Private Route Table B"

  RouteTablePrivate2Association1:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Properties:
      RouteTableId:
        Ref: "RouteTablePrivate2"
      SubnetId:
        Ref: "PrivateSubnet2"

  RouteTablePrivate2Route0:
    Type: "AWS::EC2::Route"
    Properties:
      DestinationCidrBlock: "0.0.0.0/0"
      RouteTableId:
        Ref: "RouteTablePrivate2"
      NatGatewayId:
        Ref: "NatGw1"

  RouteTablePrivate3:
    Type: "AWS::EC2::RouteTable"
    Properties:
      VpcId:
        Ref: "VPC"
      Tags:
        - Key: "Name"
          Value: "Private Route Table C"

  RouteTablePrivate3Association1:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Properties:
      RouteTableId:
        Ref: "RouteTablePrivate3"
      SubnetId:
        Ref: "PrivateSubnet3"

  RouteTablePrivate3Route0:
    Type: "AWS::EC2::Route"
    Properties:
      DestinationCidrBlock: "0.0.0.0/0"
      RouteTableId:
        Ref: "RouteTablePrivate3"
      NatGatewayId:
        Ref: "NatGw1"


  Igw:
    Type: "AWS::EC2::InternetGateway"
    Properties: { }

  IGWAttachment:
    Type: "AWS::EC2::VPCGatewayAttachment"
    Properties:
      VpcId:
        Ref: "VPC"
      InternetGatewayId:
        Ref: "Igw"

  NatGw1:
    Type: "AWS::EC2::NatGateway"
    Properties:
      SubnetId:
        Ref: "PublicSubnet1"
      AllocationId:
        Fn::GetAtt:
          - "NatGw1ElasticIP"
          - "AllocationId"
      Tags:
        - Key: "Name"
          Value: "NAT GW A"

  NatGw1ElasticIP:
    Type: "AWS::EC2::EIP"
    Properties:
      Domain: "vpc"
      Tags:
        - Key: "Name"
          Value: "NAT GW EIP"


  DBVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref DBVPCCIDR
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: "DB VPC"

  DBPrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref DBVPC
      CidrBlock: 10.1.101.0/24
      MapPublicIpOnLaunch: false
      AvailabilityZone:
        Fn::Select:
          - "0"
          - Fn::GetAZs:
              Ref: "AWS::Region"
      Tags:
        - Key: Name
          Value: "DB Private Subnet AZ A"

  DBPrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref DBVPC
      CidrBlock: 10.1.102.0/24
      MapPublicIpOnLaunch: false
      AvailabilityZone:
        Fn::Select:
          - "1"
          - Fn::GetAZs:
              Ref: "AWS::Region"
      Tags:
        - Key: Name
          Value: "DB Private Subnet AZ B"

  DBPrivateSubnet3:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref DBVPC
      CidrBlock: 10.1.103.0/24
      MapPublicIpOnLaunch: false
      AvailabilityZone:
        Fn::Select:
          - "2"
          - Fn::GetAZs:
              Ref: "AWS::Region"
      Tags:
        - Key: Name
          Value: "DB Private Subnet AZ B"

  WebToDBPeering:
    Type: AWS::EC2::VPCPeeringConnection
    Properties:
      VpcId: !Ref VPC
      PeerVpcId: !Ref DBVPC
      Tags:
        - Key: Name
          Value: "Web-to-DB Peering"

  DBRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref DBVPC
      Tags:
        - Key: Name
          Value: "DB Private Route Table"

  DBSubnetRoute1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref DBPrivateSubnet1
      RouteTableId: !Ref DBRouteTable

  DBSubnetRoute2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref DBPrivateSubnet2
      RouteTableId: !Ref DBRouteTable

  DBSubnetRoute3:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref DBPrivateSubnet3
      RouteTableId: !Ref DBRouteTable

 

  WebToDBRoute1:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref RouteTablePrivate1
      DestinationCidrBlock: !Ref DBVPCCIDR
      VpcPeeringConnectionId: !Ref WebToDBPeering

  WebToDBRoute2:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref RouteTablePrivate2
      DestinationCidrBlock: !Ref DBVPCCIDR
      VpcPeeringConnectionId: !Ref WebToDBPeering

  WebToDBRoute3:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref RouteTablePrivate3
      DestinationCidrBlock: !Ref DBVPCCIDR
      VpcPeeringConnectionId: !Ref WebToDBPeering

  DBToWebRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref DBRouteTable
      DestinationCidrBlock: !Ref VpcCIDR
      VpcPeeringConnectionId: !Ref WebToDBPeering


  WebInstanceSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      VpcId: !Ref VPC
      GroupDescription: Web tier

  DBInstanceSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      VpcId: !Ref DBVPC
      GroupDescription: MariaDB 
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          # SourceSecurityGroupId: !Ref Ec2SecurityGroup
          CidrIp: !Ref VpcCIDR   # ✅ Web VPC CIDR
          # SourceSecurityGroupId: !Ref LambdaDBSecurityGroup
        # - IpProtocol: tcp
        #   FromPort: 3000
        #   ToPort: 3000
        #   SourceSecurityGroupId: !Ref WebInstanceSG


      
  SystemsManagerEC2Role:
    Type: AWS::IAM::Role
    Properties:
      RoleName: LAMP-SystemsManagerEC2Role
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Policies:
        - PolicyName: CloudFormationReadOnlyForCfnTools
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - cloudformation:DescribeStacks
                  - cloudformation:DescribeStackResource
                  - cloudformation:DescribeStackResources
                  - cloudformation:GetTemplate
                Resource: "*"
        - PolicyName: AllowInvokeAllLambda
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: AllowInvokeAnyLambdaInAccount
                Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource: !Sub arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:*
      Tags:
        - Key: Name
          Value: SystemsManagerEC2Role

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: LAMP-SystemsManagerEC2Profile
      Roles:
        - !Ref SystemsManagerEC2Role

  ### Security Group ###
  PrivateInstanceSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      VpcId: !Ref VPC
      GroupDescription: Allow HTTP from ALB or Bastion
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: !Ref VpcCIDR
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: !Ref VpcCIDR

  AlbSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      VpcId: !Ref VPC
      GroupDescription: Enable HTTP access from internet
      GroupName: AllowHttpFromEverywhere
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: "80"
          ToPort: "80"
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0

  Ec2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      VpcId: !Ref VPC
      GroupDescription: Enable HTTP access from within VPC
      GroupName: AllowHttpFromALB
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: "80"
          ToPort: "80"
          SourceSecurityGroupId: !Ref AlbSecurityGroup
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          SourceSecurityGroupId: !Ref AlbSecurityGroup

  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: LAMP-ApplicationLoadBalancer
      Subnets:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
        - !Ref PublicSubnet3
      SecurityGroups:
        - !Ref AlbSecurityGroup
      Scheme: internet-facing
      Type: application

  HttpsTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${AWS::StackName}-https-tg"
      VpcId: !Ref VPC
      Port: 443
      Protocol: HTTPS
      HealthCheckProtocol: HTTP
      HealthCheckPort: "80"
      HealthCheckPath: /
      Matcher:
        HttpCode: 200-399

  TargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${AWS::StackName}-http-tg"
      VpcId: !Ref VPC
      Port: 80
      Protocol: HTTP
      TargetType: instance
      HealthCheckPath: /
      HealthCheckProtocol: HTTP
      HealthCheckIntervalSeconds: 30
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 2
      Matcher:
        HttpCode: 200-399
      # Targets:
      #   - Id: !Ref LampInstance
      #     Port: 80


  HttpListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: redirect
          RedirectConfig:
            Protocol: HTTPS
            Port: "443"
            StatusCode: HTTP_301
      # DefaultActions:
      #   - Type: forward
      #     TargetGroupArn: !Ref TargetGroup
      # DefaultActions:
      #   - Type: forward
      #     TargetGroupArn: !Ref HttpsTargetGroup

  HttpsListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 443
      Protocol: HTTPS
      Certificates:
        - CertificateArn: !Ref ALBCertificate
        # - CertificateArn: arn:aws:acm:eu-west-2:725673811658:certificate/ce0f8756-332a-49c1-ab9a-a4956ceb560b
      DefaultActions:
        - Order: 1
          Type: forward
          TargetGroupArn: !Ref TargetGroup
        - Order: 2
          Type: forward
          TargetGroupArn: !Ref WakeLambdaTargetGroup          

  AlbDnsRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref HostedZoneId
      # HostedZoneName: !Sub "${DomainName}."
      Name: !Sub "${DomainName}."
      Type: A
      AliasTarget:
        DNSName: !GetAtt ApplicationLoadBalancer.DNSName
        HostedZoneId: !GetAtt ApplicationLoadBalancer.CanonicalHostedZoneID
        EvaluateTargetHealth: true

  AlbDnsRecordWWW:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref HostedZoneId
      # HostedZoneName: !Sub "${DomainName}."
      Name: !Sub "www.${DomainName}."
      Type: A
      AliasTarget:
        DNSName: !GetAtt ApplicationLoadBalancer.DNSName
        HostedZoneId: !GetAtt ApplicationLoadBalancer.CanonicalHostedZoneID
        EvaluateTargetHealth: true

  HttpsListenerWwwRedirect:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref HttpsListener
      Priority: 1
      Conditions:
        - Field: host-header
          HostHeaderConfig:
            Values:
              - !Sub "www.${DomainName}"
      Actions:
        - Type: redirect
          RedirectConfig:
            Protocol: HTTPS
            Host: !Ref DomainName
            Port: "443"
            Path: "/#{path}"
            Query: "#{query}"
            StatusCode: HTTP_301

  CertificatesList:
    Type: AWS::ElasticLoadBalancingV2::ListenerCertificate
    Properties: 
      Certificates: 
        - CertificateArn: arn:aws:acm:eu-west-2:725673811658:certificate/ce0f8756-332a-49c1-ab9a-a4956ceb560b
      ListenerArn: !Ref HttpsListener

  ####################
  # Certificate
  ####################

  ALBCertificate:
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName: !Ref DomainName
      SubjectAlternativeNames:
        - !Sub "www.${DomainName}"
      ValidationMethod: DNS
      DomainValidationOptions:
        - DomainName: !Ref DomainName
          HostedZoneId: !Ref HostedZoneId
          # HostedZoneName: !Sub "${DomainName}."
        - DomainName: !Sub "www.${DomainName}"
          HostedZoneId: !Ref HostedZoneId
          # HostedZoneName: !Sub "${DomainName}."

  LampLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: lamp-stack-ec2-LaunchTemplate
      LaunchTemplateData:
        ImageId: !Sub "{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64}}"
        # ImageId: ami-07a5595e036e5def1
        InstanceType: !Ref InstanceType
        KeyName: !Ref KeyName
        IamInstanceProfile:
          Name: !Ref EC2InstanceProfile
        Monitoring:
          Enabled: true
        SecurityGroupIds:
          - !Ref Ec2SecurityGroup

        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: !Sub "${AWS::StackName}_private-subnet-EC2"
              - Key: AutoStop
                Value: true
              - Key: Environment
                Value: dev
        UserData: 
          Fn::Base64:
            !Sub |
              #!/bin/bash -xe
              #set -x for debug only not for production.
              set -x

              yum clean all
              yum update -y
              
              dnf install -y aws-cfn-bootstrap

              /opt/aws/bin/cfn-init \
                --stack ${AWS::StackName} \
                --region ${AWS::Region} \
                --resource LampAutoScalingGroup \
                --configsets default

              INIT_EXIT_CODE=$?

              /opt/aws/bin/cfn-signal \
                --exit-code $INIT_EXIT_CODE \
                --stack ${AWS::StackName} \
                --region ${AWS::Region} \
                --resource LampAutoScalingGroup

              exit $INIT_EXIT_CODE

  LampAutoScalingGroup:
    Type: 'AWS::AutoScaling::AutoScalingGroup'
    
    Metadata:
      AWS::CloudFormation::Init:
        configSets:
          default:
            - install
            - configure
            - cfn-hup
        install:
          packages:
            yum:
              # httpd: []
              wget: []
              # php: []
              # php-fpm: []
              # php-mysqlnd: []
              # php-mysqli: []
              # php-devel: []
              # php-gd: []
              # php-json: []
              # mariadb105-server: []
              openssl: []
              # mod_ssl: []
              # stress: []

        configure:

          files:
            /etc/db.conf:
              content: !Sub |
                DB_HOST=${DBNetworkInterface.PrimaryPrivateIpAddress}
              mode: "0644"
              owner: root
              group: root

            /etc/systemd/system/httpd.service.d/aws-env.conf:
              content: !Sub |
                [Service]
                Environment="AWS_REGION=${AWS::Region}"
                Environment="AWS_DEFAULT_REGION=${AWS::Region}"
              mode: "0644"
              owner: root
              group: root

            /var/www/html/lambda_invoke.php:
              content: !Sub |
                <?php
                  require '/var/www/html/vendor/autoload.php';

                  use Aws\Lambda\LambdaClient;
                  use Aws\Exception\AwsException;

                  /**
                  * Get IMDSv2 token
                  */
                  function getImdsToken() {
                      $ch = curl_init('http://169.254.169.254/latest/api/token');
                      curl_setopt_array($ch, [
                          CURLOPT_RETURNTRANSFER => true,
                          CURLOPT_CUSTOMREQUEST  => 'PUT',
                          CURLOPT_HTTPHEADER     => [
                              'X-aws-ec2-metadata-token-ttl-seconds: 21600'
                          ],
                          CURLOPT_TIMEOUT => 2
                      ]);
                      return curl_exec($ch);
                  }

                  /**
                  * Get EC2 metadata value
                  */
                  function getEc2Metadata($path, $token) {
                      $ch = curl_init("http://169.254.169.254/latest/meta-data/$path");
                      curl_setopt_array($ch, [
                          CURLOPT_RETURNTRANSFER => true,
                          CURLOPT_HTTPHEADER     => [
                              "X-aws-ec2-metadata-token: $token"
                          ],
                          CURLOPT_TIMEOUT => 2
                      ]);
                      return curl_exec($ch);
                  }

                  $token = getImdsToken();

                  $metadata = [
                      'availability_zone' => getEc2Metadata('placement/availability-zone', $token),
                      'region'            => getEc2Metadata('placement/region', $token),
                      'instance_id'       => getEc2Metadata('instance-id', $token),
                      'private_ip'        => getEc2Metadata('local-ipv4', $token),
                  ];

                  $client = new LambdaClient([
                      'version' => 'latest',
                      'region'  => $metadata['region']   // dynamically use instance region
                  ]);

                  try {
                      $result = $client->invoke([
                          'FunctionName'   => 'LAMP-DB-Logger',
                          'InvocationType'=> 'RequestResponse',
                          'Payload'       => json_encode([
                              'source'    => 'php-web',
                              'timestamp' => time(),
                              'ec2_metadata'       => $metadata
                          ])
                      ]);

                      $response = json_decode($result->get('Payload')->getContents(), true);

                      echo "<h2>Lambda invoked successfully</h2>";
                      echo "<pre>" . print_r($response, true) . "</pre>";

                  } catch (AwsException $e) {
                      echo "<h2>Error invoking Lambda</h2>";
                      echo "<pre>" . $e->getMessage() . "</pre>";
                  }
                ?>

              mode: "0644"
              owner: root
              group: root

            /var/www/html/ec2_index.php:
              content: !Sub |
                <?php
                  require '/var/www/html/vendor/autoload.php';

                  use Aws\Lambda\LambdaClient;
                  use Aws\Exception\AwsException;

                  /**
                  * Get IMDSv2 token
                  */
                  function getImdsToken() {
                      $ch = curl_init('http://169.254.169.254/latest/api/token');
                      curl_setopt_array($ch, [
                          CURLOPT_RETURNTRANSFER => true,
                          CURLOPT_CUSTOMREQUEST  => 'PUT',
                          CURLOPT_HTTPHEADER     => [
                              'X-aws-ec2-metadata-token-ttl-seconds: 21600'
                          ],
                          CURLOPT_TIMEOUT => 2
                      ]);
                      return curl_exec($ch);
                  }

                  /**
                  * Get EC2 metadata value
                  */
                  function getEc2Metadata($path, $token) {
                      $ch = curl_init("http://169.254.169.254/latest/meta-data/$path");
                      curl_setopt_array($ch, [
                          CURLOPT_RETURNTRANSFER => true,
                          CURLOPT_HTTPHEADER     => [
                              "X-aws-ec2-metadata-token: $token"
                          ],
                          CURLOPT_TIMEOUT => 2
                      ]);
                      return curl_exec($ch);
                  }

                  $token = getImdsToken();

                  $metadata = [
                      'availability_zone' => getEc2Metadata('placement/availability-zone', $token),
                      'region'            => getEc2Metadata('placement/region', $token),
                      'instance_id'       => getEc2Metadata('instance-id', $token),
                      'private_ip'        => getEc2Metadata('local-ipv4', $token),
                  ];

                  

                  try {
                      $response = $metadata;
                      echo "<h2>Welcome to EC2 </h2>";
                      echo "<pre>" . print_r($response, true) . "</pre>";
                  } catch (AwsException $e) {
                      echo "<h2>Error at EC2 home</h2>";
                      echo "<pre>" . $e->getMessage() . "</pre>";
                  }

                  phpinfo();
                ?>

              mode: "0644"
              owner: root
              group: root

          commands:
            01_permissions:
              command: |
                #set -x for debug only not for production.
                set -x
                
                #TODO check why the packages are not installed via config:packages:dnf
                #dnf isnt supported by packages, though not sure why aws wouldn't throw an error, 
                # but very well throws errors for any issues with yum install.
                # yum install is flaky given the repo isnt accessible though user data runs before the install.
                # yum update has been included in the user data.
                dnf upgrade -y
                dnf install -y --allowerasing \
                                httpd wget php php-fpm php-mysqlnd php-mysqli php-json \
                                php-devel php-gd openssl mod_ssl stress nmap-ncat telnet \
                                mariadb105 curl php-cli php-mbstring git unzip
                # mariadb105-server
                WEB_ROOT="/var/www/html"
                INDEX_FILE="$WEB_ROOT/index.php"

                # Ensure web root exists
                mkdir -p "$WEB_ROOT"

                # Create index.php only if it does not exist
                if [ ! -f "$INDEX_FILE" ]; then
                  echo '<?php phpinfo(); ?>' > "$INDEX_FILE"
                fi

                # Fix ownership and permissions
                chown apache:apache "$INDEX_FILE"
                chmod 644 "$INDEX_FILE"
                
                usermod -a -G apache ec2-user || true
                chown -R apache:apache /var/www
                find /var/www -type d -exec chmod 755 {} \;
                find /var/www -type f -exec chmod 644 {} \;

            02_start_services:
              command: |
                #set -x for debug only not for production.
                set -x
                # systemctl enable  mariadb
                systemctl enable httpd 
                # systemctl start mariadb
                # until mysqladmin ping --silent; do sleep 2; done

            05_install_wordpress:
              command: |
                #set -x for debug only not for production.
                set -x
                WEB_ROOT="/var/www/html"
                INDEX_FILE="$WEB_ROOT/index.php"
                mkdir -p "$WEB_ROOT"

                cd /tmp
                if [ ! -d /var/www/html/wp-admin ]; then
                  wget https://wordpress.org/latest.tar.gz
                  tar -xzf latest.tar.gz
                  cp -r wordpress/* /var/www/html/
                fi
                
                cp "/tmp/wordpress/index.php" "$WEB_ROOT/wp_index.php"

                cp -f "$WEB_ROOT/ec2_index.php" "$WEB_ROOT/index.php"

            06_configure_wp:
              command: !Sub |
                #set -x for debug only not for production.
                set -x

                cd /var/www/html
                
                if [ ! -f wp-config.php ]; then
                  cp wp-config-sample.php wp-config.php
                  sed -i "s/database_name_here/${WordPressDBName}/" wp-config.php
                  sed -i "s/username_here/${WordPressDBUser}/" wp-config.php
                  sed -i "s/password_here/${WordPressDBPassword}/" wp-config.php
                  sed -i "s/localhost/${DBNetworkInterface.PrimaryPrivateIpAddress}/" wp-config.php

                  curl -s https://api.wordpress.org/secret-key/1.1/salt/ >> wp-config.php
                fi

            07_fix_wp_permissions:
              command: |
                #set -x for debug only not for production.
                set -x

                chown -R apache:apache /var/www/html
                find /var/www/html -type d -exec chmod 755 {} \;
                find /var/www/html -type f -exec chmod 644 {} \;

            08_generate_self_signed_cert:
              command: |
                #set -x for debug only not for production.
                set -x

                CERT=/etc/pki/tls/certs/apache-selfsigned.crt
                KEY=/etc/pki/tls/private/apache-selfsigned.key

                if [ ! -f "$CERT" ] || [ ! -f "$KEY" ]; then

                  openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
                    -keyout $KEY \
                    -out $CERT \
                    -subj "/C=GB/ST=Scotland/L=Glasgow/O=KampliLimited/OU=IT/CN=kamplidev.com/emailAddress=kampli@gmail.com"
                fi

            09_configure_ssl:
              command: |
                #set -x for debug only not for production.
                set -x

                SSL_CONF=/etc/httpd/conf.d/ssl.conf
                sed -i \
                  -e 's|^SSLCertificateFile .*|SSLCertificateFile /etc/pki/tls/certs/apache-selfsigned.crt|' \
                  -e 's|^SSLCertificateKeyFile .*|SSLCertificateKeyFile /etc/pki/tls/private/apache-selfsigned.key|' \
                  $SSL_CONF

            10_restart_httpd:
              command: |
                #set -x for debug only not for production.
                set -x

                testFileName=/var/log/$(date +'%Y%m%d%H%M%S')_touchfile_v1.log
                touch $testFileName
                chmod 777 $testFileName

                systemctl daemon-reexec

                systemctl restart httpd

            11_install_php_composer:
              command: |
                #set -x for debug only not for production.
                set -x

                #dnf install -y --allowerasing curl php-cli php-mbstring git unzip

                mkdir -p $HOME/.config/composer
                export COMPOSER_HOME="$HOME/.config/composer";

                curl -sS https://getcomposer.org/installer -o composer-setup.php
                php composer-setup.php --check
                php composer-setup.php --install-dir=/usr/local/bin --filename=composer

                cd /var/www/html

                composer -q require aws/aws-sdk-php

                export AWS_REGION=${AWS::Region}
                echo $AWS_REGION
                echo $AWS_REGION



          services:
            systemd:
              httpd:
                enabled: true
                ensureRunning: true
              # mariadb:
              #   enabled: true
              #   ensureRunning: true

        cfn-hup:
          files:
            /etc/cfn/cfn-hup.conf:
              mode: "0400"
              owner: root
              group: root
              content: !Sub |
                [main]
                stack=${AWS::StackId}
                region=${AWS::Region}
                interval=1

            /etc/cfn/hooks.d/cfn-auto-reloader.conf:
              mode: "0400"
              owner: root
              group: root
              content: !Sub |
                [cfn-auto-reloader-hook]
                triggers=post.update
                path=Resources.LampAutoScalingGroup.Metadata.AWS::CloudFormation::Init
                action=/opt/aws/bin/cfn-init -v \
                  --stack ${AWS::StackName} \
                  --resource LampAutoScalingGroup \
                  --region ${AWS::Region} \
                  --configsets default
                runas=root

          commands:
            enable_cfn_hup:
              command: |
                #set -x for debug only not for production.
                set -x

                systemctl enable cfn-hup
                systemctl start cfn-hup
                # systemctl status cfn-hup

          services:
            systemd:
              cfn-hup:
                enabled: true
                ensureRunning: true


    CreationPolicy:
      ResourceSignal:
        Timeout: PT30M
        Count: 1
      AutoScalingCreationPolicy:
        MinSuccessfulInstancesPercent: 0

    UpdatePolicy:
      AutoScalingRollingUpdate:
        MinInstancesInService: 1
        MaxBatchSize: 3
        PauseTime: PT30M
        WaitOnResourceSignals: true

    Properties:
      AutoScalingGroupName: LampAutoScalingGroup
      DesiredCapacity: 0
      MaxSize: 3
      MinSize: 0
      VPCZoneIdentifier:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
        - !Ref PrivateSubnet3
      LaunchTemplate:
        LaunchTemplateId: !Ref LampLaunchTemplate
        Version: !GetAtt LampLaunchTemplate.LatestVersionNumber
      TargetGroupARNs:
        - !Ref TargetGroup
        # - !Ref HttpsTargetGroup
      HealthCheckType: ELB
      HealthCheckGracePeriod: 300
      Tags:
        - Key: AutoStop
          Value: true
          PropagateAtLaunch: true
        - Key: Environment
          Value: dev
          PropagateAtLaunch: true

  TargetTrackingScalingPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AutoScalingGroupName: !Ref LampAutoScalingGroup
      PolicyType: TargetTrackingScaling
      TargetTrackingConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: ASGAverageCPUUtilization
        TargetValue: 50.0
        DisableScaleIn: false


  DBInstance:
    Type: AWS::EC2::Instance
    DependsOn:
      - DBNetworkInterface
    CreationPolicy:
      ResourceSignal:
        Timeout: PT30M
    Metadata:
      AWS::CloudFormation::Init:
        configSets:
          default:
            - configure
            - cfn-hup
        configure:
          commands:
            01_install_mariadb:
              command: |
                #!/bin/bash -xe
                #TODO check why the packages are not installed via config:packages:dnf
                #set -x for debug only not for production.
                set -x
                dnf upgrade -y
                dnf install -y mariadb105-server

                systemctl stop mariadb || true

                mkfs.xfs /dev/xvdf || true
                mkdir -p /var/lib/mysql
                mount /dev/xvdf /var/lib/mysql
                echo "/dev/xvdf /var/lib/mysql xfs defaults,nofail 0 2" >> /etc/fstab

                rm -rf /var/lib/mysql/*
                chown -R mysql:mysql /var/lib/mysql

                mariadb-install-db --user=mysql --datadir=/var/lib/mysql

                sed -i 's/^bind-address.*/bind-address=0.0.0.0/' /etc/my.cnf.d/mariadb-server.cnf

                systemctl enable mariadb
                systemctl start mariadb
            03_secure_mariadb:
              command: !Sub |
                #!/bin/bash -x
                set -x
                # DBRootPassword=rootkampli00
                # WordPressDBName=wordpressdb
                # WordPressDBUser=wpuser
                # WordPressDBPassword=wpkampli00

                # mysql -u ${WordPressDBUser} -p${WordPressDBPassword}
                #  mysql -u root -p${DBRootPassword}


                # Wait for MariaDB
                until mysqladmin ping --silent; do
                  sleep 2
                done

                # Determine how to connect as root
                if mysql -u root -e "SELECT 1" >/dev/null 2>&1; then
                  MYSQL="mysql -u root"
                elif mysql -u root -p"${DBRootPassword}" -e "SELECT 1" >/dev/null 2>&1; then
                  MYSQL="mysql -u root -p${DBRootPassword}"
                else
                  echo "ERROR  Unable to authenticate to MariaDB as root"
                  exit 1
                fi

                # Check if password already matches (idempotent)
                PASSWORD_OK=$($MYSQL -Nse "
                  SELECT COUNT(*) FROM mysql.user
                  WHERE User='root'
                    AND Host='localhost'
                    AND authentication_string = PASSWORD('${DBRootPassword}');
                ")

                if [ "$PASSWORD_OK" -eq 0 ]; then
                  echo "Setting MariaDB root password"
                  $MYSQL -e "
                    ALTER USER 'root'@'localhost' IDENTIFIED BY '${DBRootPassword}';
                    FLUSH PRIVILEGES;
                  "
                else
                  echo "MariaDB root password already set — skipping"
                fi

                
                #mysql -e "ALTER USER IF EXISTS 'root'@'localhost' IDENTIFIED BY '${DBRootPassword}'; FLUSH PRIVILEGES;"
                mysql -u root --password=${DBRootPassword} -e "
                  DELETE FROM mysql.user WHERE User='';
                  DROP DATABASE IF EXISTS test;
                  FLUSH PRIVILEGES;
                "

            04_create_wordpress_db:
              command: !Sub |
                mysql -u root --password=${DBRootPassword} -e "
                  CREATE DATABASE IF NOT EXISTS ${WordPressDBName};
                  CREATE USER IF NOT EXISTS '${WordPressDBUser}'@'%'
                    IDENTIFIED BY '${WordPressDBPassword}';
                  
                  CREATE TABLE IF NOT EXISTS ${WordPressDBName}.logs (
                    id INT AUTO_INCREMENT PRIMARY KEY,
                    message VARCHAR(255),
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                  ); 
                  GRANT ALL PRIVILEGES ON ${WordPressDBName}.* TO '${WordPressDBUser}'@'%';
                  FLUSH PRIVILEGES;
                "
          services:
            systemd:
              mariadb:
                enabled: true
                ensureRunning: true          
        cfn-hup:
          files:
            /etc/cfn/cfn-hup.conf:
              mode: "0400"
              owner: root
              group: root
              content: !Sub |
                [main]
                stack=${AWS::StackId}
                region=${AWS::Region}
                interval=5

            /etc/cfn/hooks.d/cfn-auto-reloader.conf:
              mode: "0400"
              owner: root
              group: root
              content: !Sub |
                [cfn-auto-reloader-hook]
                triggers=post.update
                path=Resources.DBInstance.Metadata.AWS::CloudFormation::Init
                action=/opt/aws/bin/cfn-init \
                  --stack ${AWS::StackName} \
                  --resource DBInstance \
                  --region ${AWS::Region} \
                  --configsets default
                runas=root

          services:
            systemd:
              cfn-hup:
                enabled: true
                ensureRunning: true

    Properties:
      InstanceType: t2.micro
      ImageId: !Sub "{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64}}"
      KeyName: !Ref KeyName
      # SubnetId: !Ref DBPrivateSubnet1
      # SecurityGroupIds:
      #   - !Ref DBInstanceSG
      IamInstanceProfile: !Ref EC2InstanceProfile
      NetworkInterfaces:
        - NetworkInterfaceId: !Ref DBNetworkInterface
          DeviceIndex: 0
      Tags:
        - Key: Name
          Value: MariaDB-Primary
        - Key: AutoStop
          Value: true
        - Key: Environment
          Value: dev
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash -xe

          
          dnf install -y aws-cfn-bootstrap

          /opt/aws/bin/cfn-init \
            --stack ${AWS::StackName} \
            --resource DBInstance \
            --region ${AWS::Region} \
            --configsets default

          INIT_EXIT_CODE=$?

          /opt/aws/bin/cfn-signal \
            --exit-code $INIT_EXIT_CODE \
            --stack ${AWS::StackName} \
            --resource DBInstance \
            --region ${AWS::Region}
          
          exit $INIT_EXIT_CODE

  

  DBDataVolume:
    Type: AWS::EC2::Volume
    Properties:
      AvailabilityZone:
        Fn::Select:
          - 0
          - Fn::GetAZs: !Ref AWS::Region
      Size: 8
      VolumeType: gp3
      Encrypted: true
      Tags:
        - Key: Name
          Value: MariaDB-Data



  DBVolumeAttachment:
    Type: AWS::EC2::VolumeAttachment
    DependsOn:
      - DBInstance
      - DBDataVolume
    Properties:
      InstanceId: !Ref DBInstance
      VolumeId: !Ref DBDataVolume
      Device: /dev/xvdf


  DBNetworkInterface:
    Type: AWS::EC2::NetworkInterface
    Properties:
      SubnetId: !Ref DBPrivateSubnet1
      GroupSet:
        - !Ref DBInstanceSG
      Description: Primary ENI for MariaDB
      Tags:
        - Key: Name
          Value: MariaDB-Primary-ENI


  DBInternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: DB-VPC-IGW

  DBIGWAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref DBVPC
      InternetGatewayId: !Ref DBInternetGateway


  DBPublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref DBVPC
      CidrBlock: 10.1.1.0/24
      MapPublicIpOnLaunch: true
      AvailabilityZone:
        Fn::Select:
          - 0
          - Fn::GetAZs: !Ref AWS::Region
      Tags:
        - Key: Name
          Value: DB-Public-Subnet

  DBPublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref DBVPC
      Tags:
        - Key: Name
          Value: DB-Public-RT

  DBPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: DBIGWAttachment
    Properties:
      RouteTableId: !Ref DBPublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref DBInternetGateway

  DBPublicSubnetRouteAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref DBPublicSubnet
      RouteTableId: !Ref DBPublicRouteTable


  DBNatEIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: DB-NAT-EIP

  DBNatGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      SubnetId: !Ref DBPublicSubnet
      AllocationId: !GetAtt DBNatEIP.AllocationId
      Tags:
        - Key: Name
          Value: DB-NAT-Gateway

  DBPrivateDefaultRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref DBRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref DBNatGateway



  LambdaDBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      VpcId: !Ref VPC
      GroupDescription: Allow Lambda to access MariaDB
      SecurityGroupEgress:
      - IpProtocol: tcp
        FromPort: 3306
        ToPort: 3306
        CidrIp: !Ref DBVPCCIDR


  WordpressLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: LAMP-DB-Logger
      Runtime: python3.11
      Handler: lambda_function.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 120
      Layers:
        - !Ref PymysqlLayer
      Environment:
        Variables:
          DB_HOST: !GetAtt DBNetworkInterface.PrimaryPrivateIpAddress
          DB_USER: wpuser
          DB_PASSWORD: !Ref WordPressDBPassword
          DB_NAME: !Ref WordPressDBName
          LAMBDA_AWS_REGION: !Ref AWS::Region
          LAMBDA_AWS_STACK: !Ref AWS::StackName
      VpcConfig:
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
          - !Ref PrivateSubnet3
        SecurityGroupIds:
          - !Ref LambdaDBSecurityGroup
      Code:
        S3Bucket: !Ref LambdaArtifactsS3BucketName
        S3Key: lambda.zip

  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: LAMP-Lambda-ExecutionRole
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      Policies:
        - PolicyName: root
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action: 's3:*'
                Resource: '*'
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
        - arn:aws:iam::aws:policy/AmazonRDSFullAccess
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole




  ##########################
  # PyMySQL Lambda Layer   #
  ##########################
  PymysqlLayer:
    Type: AWS::Lambda::LayerVersion
    Properties:
      LayerName: pymysql-layer
      Description: PyMySQL for Lambda
      Content:
        S3Bucket: !Ref LambdaArtifactsS3BucketName
        S3Key: pymysql-layer.zip
      CompatibleRuntimes:
        - python3.11

  AutoStopLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: AutoStopLambda
      Runtime: python3.11
      Handler: lambda_autostop.handler
      Role: !GetAtt AutoStartStopLambdaRole.Arn
      Timeout: 60
      Layers:
        - !Ref PymysqlLayer
      Code:
        S3Bucket: !Ref LambdaArtifactsS3BucketName
        S3Key: lambda.zip

  AutoStartStopLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: AutoStopPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - ec2:DescribeInstances
                  - ec2:StartInstances
                  - ec2:StopInstances
                  - autoscaling:DescribeAutoScalingGroups
                  - autoscaling:UpdateAutoScalingGroup
                Resource: "*"


  AutoStopRule:
    Type: AWS::Events::Rule
    Properties:
      Name: AutoStoptRule
      Description: stop non-prod resources in the evening
      ScheduleExpression: cron(0 19 ? * MON-FRI *)
      Targets:
        - Arn: !GetAtt AutoStopLambda.Arn
          Id: AutoStopTarget


  AutoStopLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref AutoStopLambda
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt AutoStopRule.Arn


  AutoStartLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: AutoStartLambda
      Runtime: python3.11
      Handler: lambda_autostart.handler
      Role: !GetAtt AutoStartStopLambdaRole.Arn
      Timeout: 60
      Layers:
        - !Ref PymysqlLayer
      Code:
        S3Bucket: !Ref LambdaArtifactsS3BucketName
        S3Key: lambda.zip

  AutoStartRule:
    Type: AWS::Events::Rule
    Properties:
      Name: AutoStartRule
      Description: Start non-prod resources in the morning
      ScheduleExpression: cron(0 8 ? * MON-FRI *)
      State: ENABLED
      Targets:
        - Arn: !GetAtt AutoStartLambda.Arn
          Id: AutoStartLambdaTarget

  AutoStartLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref AutoStartLambda
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt AutoStartRule.Arn

  WakeAutoScalingLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: WakeAutoScalingLambda
      Runtime: python3.11
      Handler: lambda_auto_asgwake.handler
      Role: !GetAtt AutoStartStopLambdaRole.Arn
      Timeout: 60
      Layers:
        - !Ref PymysqlLayer
      Code:
        S3Bucket: !Ref LambdaArtifactsS3BucketName
        S3Key: lambda.zip

  WakeLambdaTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      TargetType: lambda

  WakeLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref WakeAutoScalingLambda
      Action: lambda:InvokeFunction
      Principal: elasticloadbalancing.amazonaws.com

  SleepAutoScalingLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: SleepAutoScalingLambda
      Runtime: python3.11
      Handler: lambda_auto_asg_sleep.handler
      Role: !GetAtt AutoStartStopLambdaRole.Arn
      Timeout: 60
      Layers:
        - !Ref PymysqlLayer
      Code:
        S3Bucket: !Ref LambdaArtifactsS3BucketName
        S3Key: lambda.zip


  IdleRequestAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: Stop ASG when idle
      Namespace: AWS/ApplicationELB
      MetricName: RequestCount
      Dimensions:
        - Name: LoadBalancer
          Value: !GetAtt ApplicationLoadBalancer.LoadBalancerFullName
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 0
      ComparisonOperator: LessThanOrEqualToThreshold
      AlarmActions:
        - !GetAtt SleepAutoScalingLambda.Arn

  IdleStopLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref SleepAutoScalingLambda
      Action: lambda:InvokeFunction
      Principal: cloudwatch.amazonaws.com

Outputs:
  LoadBalancerName:
    Description: LoadBalancerName
    # Value: !GetAtt LampInstance.PublicIp
    Value: !GetAtt ApplicationLoadBalancer.LoadBalancerFullName

  PublicDNS:
    Description: Public DNS of the LAMP Stack EC2
    # Value: !GetAtt LampInstance.PublicDnsName
    Value: !GetAtt ApplicationLoadBalancer.DNSName

  InstanceName:
    Description: Name of the LAMP EC2 instance
    Value: !Sub "${AWS::StackName}_private-subnet-EC2"

  WebsiteURL:
    Description: URL of the LAMP Stack
    # Value: !Sub "http://${LampInstance.PublicDnsName}"
    # Value: !Sub "http://${NatGw1ElasticIP.PublicIp}"
    Value: !Sub "http://${ApplicationLoadBalancer.DNSName}"

  DBPrivateIP:
    Description: Stable private IP of MariaDB
    Value: !GetAtt DBNetworkInterface.PrimaryPrivateIpAddress
